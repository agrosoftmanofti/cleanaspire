@inject OnlineStatusService OnlineStatusService

<div class="network-status-indicator">
    <MudTooltip Text="@statusTooltip">
        <MudImage Src="@statusImageBase64" Alt="Network Status" Width="15" Height="15" />
    </MudTooltip>
</div>

@code {
    private string statusImageBase64 = ""; // Default Base64 for loading
    private string statusTooltip = "Loading..."; // Default tooltip message

    // Base64 strings for green, red, and loading SVGs
    private readonly string greenPointBase64 = "data:image/svg+xml;base64,77u/PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNSIgaGVpZ2h0PSIyNSIgdmlld0JveD0iMCAwIDI1IDI1Ij4NCiAgICA8IS0tIOWFieaZleaViOaenCAtLT4NCiAgICA8ZGVmcz4NCiAgICAgICAgPGZpbHRlciBpZD0iZ2xvdyIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSI+DQogICAgICAgICAgICA8ZmVHYXVzc2lhbkJsdXIgaW49IlNvdXJjZUdyYXBoaWMiIHN0ZERldmlhdGlvbj0iNSIgcmVzdWx0PSJibHVyIiAvPg0KICAgICAgICAgICAgPGZlTWVyZ2U+DQogICAgICAgICAgICAgICAgPGZlTWVyZ2VOb2RlIGluPSJibHVyIiAvPg0KICAgICAgICAgICAgICAgIDxmZU1lcmdlTm9kZSBpbj0iU291cmNlR3JhcGhpYyIgLz4NCiAgICAgICAgICAgIDwvZmVNZXJnZT4NCiAgICAgICAgPC9maWx0ZXI+DQoNCiAgICAgICAgPCEtLSDliqjnlLvmlYjmnpwgLS0+DQogICAgICAgIDxzdHlsZT4NCiAgICAgICAgICAgIEBrZXlmcmFtZXMgZ2xvd1B1bHNlIHsNCiAgICAgICAgICAgIDAlIHsNCiAgICAgICAgICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCBncmVlbik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICAyNSUgew0KICAgICAgICAgICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMjBweCBncmVlbik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICA1MCUgew0KICAgICAgICAgICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMzBweCBncmVlbik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICA3NSUgew0KICAgICAgICAgICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMjBweCBncmVlbik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICAxMDAlIHsNCiAgICAgICAgICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCBncmVlbik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC5nbG93aW5nIHsNCiAgICAgICAgICAgIGFuaW1hdGlvbjogZ2xvd1B1bHNlIDEuNXMgaW5maW5pdGU7DQogICAgICAgICAgICB9DQogICAgICAgIDwvc3R5bGU+DQogICAgPC9kZWZzPg0KDQogICAgPCEtLSDnkIPlvaLmlYjmnpwgLS0+DQogICAgPHJhZGlhbEdyYWRpZW50IGlkPSJzcGhlcmVHcmFkaWVudCIgY3g9IjUwJSIgY3k9IjUwJSIgcj0iNTAlIiBmeD0iMzAlIiBmeT0iMzAlIj4NCiAgICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzAwRkYwMCIgLz4NCiAgICAgICAgPHN0b3Agb2Zmc2V0PSI3MCUiIHN0b3AtY29sb3I9IiMwMDdGMDAiIC8+DQogICAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzAwNEYwMCIgLz4NCiAgICA8L3JhZGlhbEdyYWRpZW50Pg0KDQogICAgPCEtLSDlsI/nu7/ngrkgd2l0aCAzRCBzcGhlcmUgZWZmZWN0IC0tPg0KICAgIDxjaXJjbGUgY3g9IjEyLjUiIGN5PSIxMi41IiByPSIxMCIgZmlsbD0idXJsKCNzcGhlcmVHcmFkaWVudCkiIGNsYXNzPSJnbG93aW5nIiAvPg0KPC9zdmc+DQo=";
    private readonly string redPointBase64 = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNSIgaGVpZ2h0PSIyNSIgdmlld0JveD0iMCAwIDI1IDI1Ij4NCiAgICA8IS0tIOWFieaZleaViOaenCAtLT4NCiAgICA8ZGVmcz4NCiAgICAgICAgPGZpbHRlciBpZD0iZ2xvdyIgeD0iLTUwJSIgeT0iLTUwJSIgd2lkdGg9IjIwMCUiIGhlaWdodD0iMjAwJSI+DQogICAgICAgICAgICA8ZmVHYXVzc2lhbkJsdXIgaW49IlNvdXJjZUdyYXBoaWMiIHN0ZERldmlhdGlvbj0iNSIgcmVzdWx0PSJibHVyIiAvPg0KICAgICAgICAgICAgPGZlTWVyZ2U+DQogICAgICAgICAgICAgICAgPGZlTWVyZ2VOb2RlIGluPSJibHVyIiAvPg0KICAgICAgICAgICAgICAgIDxmZU1lcmdlTm9kZSBpbj0iU291cmNlR3JhcGhpYyIgLz4NCiAgICAgICAgICAgIDwvZmVNZXJnZT4NCiAgICAgICAgPC9maWx0ZXI+DQoNCiAgICAgICAgPCEtLSDliqjnlLvmlYjmnpwgLS0+DQogICAgICAgIDxzdHlsZT4NCiAgICAgICAgICAgIEBrZXlmcmFtZXMgZ2xvd1B1bHNlIHsNCiAgICAgICAgICAgIDAlIHsNCiAgICAgICAgICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDVweCByZWQpOw0KICAgICAgICAgICAgb3BhY2l0eTogMTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIDI1JSB7DQogICAgICAgICAgICBmaWx0ZXI6IGRyb3Atc2hhZG93KDAgMCAyMHB4IHJlZCk7DQogICAgICAgICAgICBvcGFjaXR5OiAwLjg7DQogICAgICAgICAgICB9DQogICAgICAgICAgICA1MCUgew0KICAgICAgICAgICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgMzBweCByZWQpOw0KICAgICAgICAgICAgb3BhY2l0eTogMC42Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgNzUlIHsNCiAgICAgICAgICAgIGZpbHRlcjogZHJvcC1zaGFkb3coMCAwIDIwcHggcmVkKTsNCiAgICAgICAgICAgIG9wYWNpdHk6IDAuODsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIDEwMCUgew0KICAgICAgICAgICAgZmlsdGVyOiBkcm9wLXNoYWRvdygwIDAgNXB4IHJlZCk7DQogICAgICAgICAgICBvcGFjaXR5OiAxOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAuZ2xvd2luZyB7DQogICAgICAgICAgICBhbmltYXRpb246IGdsb3dQdWxzZSAxLjVzIGluZmluaXRlOw0KICAgICAgICAgICAgfQ0KICAgICAgICA8L3N0eWxlPg0KICAgIDwvZGVmcz4NCg0KICAgIDwhLS0g55CD5b2i5pWI5p6cIC0tPg0KICAgIDxyYWRpYWxHcmFkaWVudCBpZD0ic3BoZXJlR3JhZGllbnQiIGN4PSI1MCUiIGN5PSI1MCUiIHI9IjUwJSIgZng9IjMwJSIgZnk9IjMwJSI+DQogICAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNGRjAwMDAiIC8+DQogICAgICAgIDxzdG9wIG9mZnNldD0iNzAlIiBzdG9wLWNvbG9yPSIjN0YwMDAwIiAvPg0KICAgICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM0RjAwMDAiIC8+DQogICAgPC9yYWRpYWxHcmFkaWVudD4NCg0KICAgIDwhLS0g5bCP57qi54K5IHdpdGggM0Qgc3BoZXJlIGVmZmVjdCAtLT4NCiAgICA8Y2lyY2xlIGN4PSIxMi41IiBjeT0iMTIuNSIgcj0iMTAiIGZpbGw9InVybCgjc3BoZXJlR3JhZGllbnQpIiBjbGFzcz0iZ2xvd2luZyIgLz4NCjwvc3ZnPg==";
    private readonly string loadingBase64 = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNSIgaGVpZ2h0PSIyNSIgdmlld0JveD0iMCAwIDEwMCAxMDAiIHByZXNlcnZlQXNwZWN0UmF0aW89InhNaWRZTWlkIj4NCiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iMzUiIHN0cm9rZS13aWR0aD0iOCIgc3Ryb2tlPSIjMzQ5OGRiIiBzdHJva2UtZGFzaGFycmF5PSI1NSA1NSIgZmlsbD0ibm9uZSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIj4NCiAgICA8YW5pbWF0ZVRyYW5zZm9ybSANCiAgICAgIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgDQogICAgICB0eXBlPSJyb3RhdGUiIA0KICAgICAgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIA0KICAgICAgZHVyPSIwLjhzIiANCiAgICAgIHZhbHVlcz0iMCA1MCA1MDszNjAgNTAgNTAiIA0KICAgICAga2V5VGltZXM9IjA7MSIvPg0KICA8L2NpcmNsZT4NCiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iMjUiIHN0cm9rZS13aWR0aD0iNiIgc3Ryb2tlPSIjZTc0YzNjIiBzdHJva2UtZGFzaGFycmF5PSI0MCA0MCIgZmlsbD0ibm9uZSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIj4NCiAgICA8YW5pbWF0ZVRyYW5zZm9ybSANCiAgICAgIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgDQogICAgICB0eXBlPSJyb3RhdGUiIA0KICAgICAgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIA0KICAgICAgZHVyPSIxLjJzIiANCiAgICAgIHZhbHVlcz0iMzYwIDUwIDUwOzAgNTAgNTAiIA0KICAgICAga2V5VGltZXM9IjA7MSIvPg0KICA8L2NpcmNsZT4NCjwvc3ZnPg==";

    protected override async Task OnInitializedAsync()
    {
        // Set default loading image
        statusImageBase64 = loadingBase64;

        // Initialize the service and JavaScript module
        await OnlineStatusService.InitializeAsync();

        // Get the current network status and update the image and tooltip
        bool isOnline = await OnlineStatusService.GetOnlineStatusAsync();
        UpdateStatus(isOnline);

        // Subscribe to network status change events
        OnlineStatusService.OnlineStatusChanged += UpdateStatus;

        // Register the network status listener
        await OnlineStatusService.RegisterOnlineStatusListenerAsync();
    }

    private void UpdateStatus(bool isOnline)
    {
        // Update the Base64 image and tooltip based on the network status
        statusImageBase64 = isOnline ? greenPointBase64 : redPointBase64;
        statusTooltip = isOnline ? "Online" : "Offline";
        InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        // Unsubscribe from events and dispose of resources
        OnlineStatusService.OnlineStatusChanged -= UpdateStatus;
        await OnlineStatusService.DisposeAsync();
    }
}
